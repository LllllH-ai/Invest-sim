# 回测框架设计说明

## 📚 什么是回测？

**回测（Backtesting）** 是使用历史数据来验证投资策略在过去的表现。它帮助我们：
- 评估策略的有效性
- 理解策略在不同市场环境下的表现
- 优化策略参数
- 评估风险和收益特征

## 🏗️ 回测框架的核心组件

### 1. **数据层（Data Layer）**

#### 历史价格数据
```python
# 数据格式：CSV/Excel/Parquet
# 索引：日期（DatetimeIndex）
# 列：各资产的价格
date,股票_大盘,基金_混合,债券_国债,现金
2020-01-01,100.0,10.0,100.0,1.0
2020-01-02,101.2,10.1,100.1,1.0
...
```

**关键特性：**
- 支持多种数据格式（CSV、Excel、Parquet）
- 自动识别日期列
- 处理缺失值和数据对齐

### 2. **配置层（Configuration Layer）**

#### 回测配置（BacktestConfig）
```json
{
  "initial_balance": 100000,        // 初始资金
  "rebalance_frequency": 21,        // 再平衡频率（交易日）
  "asset_weights": {                // 资产权重分配
    "股票_大盘": 0.40,
    "基金_混合": 0.30,
    "债券_国债": 0.20,
    "现金": 0.10
  },
  "strategy": {                     // 策略配置
    "name": "fixed",                // 策略类型
    "rebalance_threshold": 0.05     // 再平衡阈值
  }
}
```

**配置要素：**
- **初始资金**：回测起始金额
- **资产权重**：各资产的目标配置比例
- **再平衡频率**：多久调整一次仓位
- **策略类型**：使用的投资策略

### 3. **策略层（Strategy Layer）**

#### 策略类型

**1. 固定权重策略（Fixed Allocation）**
- 每次再平衡时都恢复到目标权重
- 适合：长期持有、定期调仓
- 优点：简单、可预测
- 缺点：可能产生较多交易成本

**2. 自适应再平衡策略（Adaptive Rebalance）**
- 只有当权重偏离超过阈值时才调仓
- 适合：减少交易频率、降低交易成本
- 优点：减少不必要的调仓
- 缺点：可能偏离目标配置较远

**3. 目标风险策略（Target Risk）**
- 根据市场波动动态调整仓位
- 适合：风险控制、波动率管理
- 优点：风险可控
- 缺点：可能错失上涨机会

### 4. **执行层（Execution Layer）**

#### 回测引擎（Backtester）

**核心流程：**
```
1. 初始化
   ├─ 加载历史价格数据
   ├─ 解析回测配置
   └─ 初始化策略

2. 逐日模拟
   ├─ 计算当日资产价格变化
   ├─ 更新组合价值
   ├─ 检查是否需要再平衡
   │  ├─ 是 → 执行策略，调整权重
   │  └─ 否 → 保持当前权重
   └─ 记录历史数据

3. 生成结果
   ├─ 组合价值时间序列
   ├─ 权重历史
   ├─ 收益率序列
   └─ 风险指标
```

**关键计算：**
- **组合价值** = Σ(资产价格 × 持有数量)
- **权重** = (资产市值) / (总组合价值)
- **收益率** = (今日价值 - 昨日价值) / 昨日价值

### 5. **结果层（Result Layer）**

#### 回测结果（BacktestResult）

**包含数据：**
- `dates`: 日期序列
- `portfolio_values`: 组合价值时间序列
- `weights_history`: 权重历史（每日各资产权重）
- `returns`: 收益率时间序列

**计算指标：**
- **总收益率** = (最终价值 - 初始价值) / 初始价值
- **年化收益率** = (1 + 总收益率)^(1/年数) - 1
- **年化波动率** = 收益率标准差 × √252
- **夏普比率** = (年化收益率 - 无风险利率) / 年化波动率
- **最大回撤** = 从峰值到谷底的最大跌幅

## 🔄 回测 vs 前瞻性模拟

| 特性 | 回测（Backtest） | 前瞻性模拟（Forward Simulation） |
|------|----------------|--------------------------------|
| **数据来源** | 真实历史价格 | 假设的统计参数 |
| **时间方向** | 向后（过去） | 向前（未来） |
| **结果类型** | 单一历史路径 | Monte Carlo 多条路径 |
| **用途** | 验证策略历史表现 | 预测未来可能结果 |
| **配置** | `BacktestConfig` | `SimulationConfig` |

## 📊 常见回测框架对比

### 1. **QuantConnect / Lean**
- 功能：完整的量化交易平台
- 特点：支持多资产、多策略、实时交易
- 适用：专业量化交易

### 2. **Backtrader**
- 功能：Python 回测框架
- 特点：事件驱动、支持多种数据源
- 适用：策略开发和回测

### 3. **Zipline**
- 功能：算法交易库
- 特点：最初由 Quantopian 开发
- 适用：研究和教育

### 4. **我们的框架（invest-sim）**
- 功能：投资组合模拟和回测
- 特点：
  - ✅ 简单易用
  - ✅ 支持多种策略
  - ✅ 清晰的配置接口
  - ✅ 完整的风险指标
  - ✅ 可视化报告
- 适用：个人投资者、策略研究

## 🎯 使用示例

### 1. 生成模拟数据
```bash
python -m invest_sim.scripts.generate_sample_data \
    --output data/sample_prices.csv \
    --start-date 2020-01-01 \
    --end-date 2024-12-31
```

### 2. 运行单个回测
```bash
invest-sim backtest \
    --config examples/backtest_balanced.json \
    --data data/sample_prices.csv
```

### 3. 运行多策略对比
```bash
python -m invest_sim.scripts.run_backtest_demo \
    --data data/sample_prices.csv \
    --config-dir examples \
    --output output
```

## ⚠️ 回测的局限性

1. **过拟合风险**：策略可能在历史数据上表现好，但未来表现差
2. **幸存者偏差**：只包含存活到现在的资产，忽略了已退市的
3. **交易成本**：实际交易有手续费、滑点等成本
4. **市场环境变化**：过去有效的策略未来可能失效
5. **数据质量**：历史数据可能有错误或缺失

## 💡 最佳实践

1. **使用足够长的历史数据**：至少覆盖一个完整的经济周期
2. **样本外测试**：保留一部分数据用于验证，不用于策略开发
3. **考虑交易成本**：在回测中加入合理的手续费假设
4. **多策略对比**：不要只看单一策略，对比多个策略
5. **风险控制**：关注最大回撤、波动率等风险指标，不只是收益率

## 📈 下一步

- 尝试不同的策略配置
- 调整再平衡频率，观察影响
- 添加交易成本到回测中
- 使用真实市场数据（如 Yahoo Finance、Tushare 等）
- 开发自定义策略

