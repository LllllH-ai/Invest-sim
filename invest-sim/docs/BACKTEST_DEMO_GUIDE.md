# 回测演示指南

## 🎯 快速开始

### 1. 生成模拟历史数据

```bash
cd invest-sim
python -m scripts.generate_sample_data --output data/sample_prices.csv
```

这将生成 2020-2024 年共 5 年的模拟历史价格数据，包括：
- **股票_大盘**：12% 年化收益，20% 波动率
- **股票_成长**：15% 年化收益，30% 波动率（高风险高收益）
- **基金_混合**：8% 年化收益，12% 波动率
- **基金_债券**：4% 年化收益，5% 波动率
- **债券_国债**：3% 年化收益，3% 波动率（低风险低收益）
- **现金**：2% 年化收益，几乎无波动

### 2. 运行回测演示

```bash
python -m scripts.run_backtest_demo \
    --data data/sample_prices.csv \
    --config-dir examples \
    --output output
```

这将运行多个策略的回测并生成对比报告。

## 📊 策略配置说明

### 1. **平衡策略（balanced）**
- **资产配置**：40% 股票_大盘 + 30% 基金_混合 + 20% 债券_国债 + 10% 现金
- **特点**：风险与收益平衡
- **适用**：稳健型投资者

### 2. **激进策略（aggressive）**
- **资产配置**：30% 股票_大盘 + 50% 股票_成长 + 15% 基金_混合 + 5% 现金
- **特点**：高股票占比，追求高收益
- **适用**：风险承受能力强的投资者

### 3. **保守策略（conservative）**
- **资产配置**：30% 基金_混合 + 40% 基金_债券 + 20% 债券_国债 + 10% 现金
- **特点**：低风险，稳定收益
- **适用**：风险厌恶型投资者

### 4. **自适应策略（adaptive）**
- **资产配置**：与平衡策略相同
- **特点**：只有当权重偏离超过 10% 时才再平衡，减少交易频率
- **适用**：希望降低交易成本的投资者

## 📈 回测结果解读

### 关键指标说明

1. **总收益率**：整个回测期间的总收益
   - 公式：`(最终价值 - 初始价值) / 初始价值`

2. **年化收益率**：将总收益率转换为年化
   - 公式：`(1 + 总收益率)^(1/年数) - 1`

3. **年化波动率**：收益率的波动程度（风险指标）
   - 越高表示风险越大

4. **夏普比率**：风险调整后的收益指标
   - 公式：`(年化收益率 - 无风险利率) / 年化波动率`
   - 越高越好，表示单位风险的收益更高

5. **最大回撤**：从峰值到谷底的最大跌幅
   - 负数，绝对值越大表示风险越大

### 示例结果对比

根据我们的回测结果（2020-2024）：

| 策略 | 总收益率 | 年化收益率 | 年化波动率 | 夏普比率 | 最大回撤 |
|------|---------|-----------|-----------|---------|---------|
| **balanced** | 48.88% | 8.29% | 8.67% | 0.96 | -9.91% |
| **aggressive** | 48.33% | 8.21% | 15.99% | 0.51 | -24.02% |
| **conservative** | 23.25% | 4.27% | 4.17% | 1.02 | -5.85% |
| **adaptive** | 47.95% | 8.15% | 9.01% | 0.90 | -10.26% |

**观察：**
- **balanced** 策略在收益和风险之间取得了最佳平衡
- **aggressive** 策略虽然收益相近，但波动率和最大回撤都显著更高
- **conservative** 策略风险最低，但收益也最低
- **adaptive** 策略与 balanced 相近，但通过减少再平衡频率可能降低了交易成本

## 📁 输出文件说明

运行回测后，会在 `output/` 目录生成以下文件：

```
output/
├── report_balanced.txt          # 平衡策略详细报告
├── report_aggressive.txt        # 激进策略详细报告
├── report_conservative.txt      # 保守策略详细报告
├── report_adaptive.txt          # 自适应策略详细报告
├── strategy_comparison.csv      # 策略对比表格
├── charts_balanced/             # 平衡策略图表
│   ├── portfolio_overview.png   # 组合价值走势和权重变化
│   ├── returns_distribution.png # 收益率分布
│   └── drawdown.png             # 回撤图
├── charts_aggressive/           # 激进策略图表
├── charts_conservative/         # 保守策略图表
└── charts_adaptive/             # 自适应策略图表
```

## 🔧 自定义回测

### 创建自己的策略配置

1. 复制一个现有配置文件：
```bash
cp examples/backtest_balanced.json examples/my_strategy.json
```

2. 编辑配置文件，修改资产权重：
```json
{
  "initial_balance": 100000,
  "rebalance_frequency": 21,
  "asset_weights": {
    "股票_大盘": 0.50,
    "基金_混合": 0.30,
    "债券_国债": 0.20
  },
  "strategy": {
    "name": "fixed"
  }
}
```

3. 运行回测：
```bash
invest-sim backtest \
    --config examples/my_strategy.json \
    --data data/sample_prices.csv
```

### 使用真实数据

你可以使用真实的历史价格数据替换模拟数据：

1. 准备 CSV 文件，格式如下：
```csv
date,股票_大盘,基金_混合,债券_国债,现金
2020-01-01,100.0,10.0,100.0,1.0
2020-01-02,101.2,10.1,100.1,1.0
...
```

2. 使用该文件运行回测：
```bash
invest-sim backtest \
    --config examples/backtest_balanced.json \
    --data your_data.csv
```

## 💡 回测框架设计要点

### 1. **数据层**
- 支持多种数据格式（CSV、Excel、Parquet）
- 自动处理日期索引和缺失值
- 灵活的数据加载接口

### 2. **配置层**
- JSON 格式，易于编辑和理解
- 类型验证，避免配置错误
- 支持多种策略类型

### 3. **策略层**
- 策略接口统一，易于扩展
- 支持固定权重、自适应、目标风险等策略
- 策略与数据解耦

### 4. **执行层**
- 逐日模拟，精确还原历史
- 支持定期再平衡
- 支持定投计划

### 5. **结果层**
- 丰富的风险指标
- 可视化图表
- 多策略对比

## ⚠️ 注意事项

1. **过拟合风险**：策略在历史数据上表现好，不代表未来也会好
2. **交易成本**：实际交易有手续费、滑点等成本，回测中未考虑
3. **数据质量**：确保历史数据准确完整
4. **市场环境变化**：过去有效的策略未来可能失效
5. **幸存者偏差**：只包含存活到现在的资产

## 🚀 下一步

- 尝试不同的资产配置比例
- 调整再平衡频率，观察影响
- 添加交易成本到回测中
- 使用真实市场数据
- 开发自定义策略

## 📚 相关文档

- [回测框架设计说明](BACKTEST_FRAMEWORK.md)
- [API 文档](../README.md)

